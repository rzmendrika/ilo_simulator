wysihtml.commands.addTableCells={exec:function(e,k,l){if(e.tableSelection&&e.tableSelection.start&&e.tableSelection.end){var h=wysihtml.dom.table.orderSelectionEnds(e.tableSelection.start,e.tableSelection.end);"before"==l||"above"==l?wysihtml.dom.table.addCells(h.start,l):("after"==l||"below"==l)&&wysihtml.dom.table.addCells(h.end,l);setTimeout(function(){e.tableSelection.select(h.start,h.end)},0)}},state:function(e,k){return!1}};
wysihtml.commands.createTable={exec:function(e,k,l){var h;if(l&&l.cols&&l.rows&&0<parseInt(l.cols,10)&&0<parseInt(l.rows,10)){var m=l.tableStyle?'<table style="'+l.tableStyle+'">':"<table>";m+="<tbody>";for(h=0;h<l.rows;h++){m+="<tr>";for(k=0;k<l.cols;k++)m+="<td><br></td>";m+="</tr>"}e.commands.exec("insertHTML",m+"</tbody></table>")}},state:function(e,k){return!1}};
wysihtml.commands.deleteTableCells={exec:function(e,k,l){if(e.tableSelection&&e.tableSelection.start&&e.tableSelection.end){k=wysihtml.dom.table.orderSelectionEnds(e.tableSelection.start,e.tableSelection.end);var h=wysihtml.dom.table.indexOf(k.start),m,n=e.tableSelection.table;wysihtml.dom.table.removeCells(k.start,l);setTimeout(function(){m=wysihtml.dom.table.findCell(n,h);m||("row"==l&&(m=wysihtml.dom.table.findCell(n,{row:h.row-1,col:h.col})),"column"==l&&(m=wysihtml.dom.table.findCell(n,{row:h.row,
col:h.col-1})));m&&e.tableSelection.select(m,m)},0)}},state:function(e,k){return!1}};
wysihtml.commands.mergeTableCells={exec:function(e,k){e.tableSelection&&e.tableSelection.start&&e.tableSelection.end&&(this.state(e,k)?wysihtml.dom.table.unmergeCell(e.tableSelection.start):wysihtml.dom.table.mergeCellsBetween(e.tableSelection.start,e.tableSelection.end))},state:function(e,k){return e.tableSelection&&(k=e.tableSelection.start,e=e.tableSelection.end,k&&e&&k==e&&(wysihtml.dom.getAttribute(k,"colspan")&&1<parseInt(wysihtml.dom.getAttribute(k,"colspan"),10)||wysihtml.dom.getAttribute(k,
"rowspan")&&1<parseInt(wysihtml.dom.getAttribute(k,"rowspan"),10)))?[k]:!1}};
(function(){function e(a,b){for(var d=[],f,g=0,h=a.length;g<h;g++)if(f=a[g].querySelectorAll(b))for(var q=f.length;q--;d.unshift(f[q]));return d}function k(a){a.parentNode.removeChild(a)}function l(a,b){a.parentNode.insertBefore(b,a.nextSibling)}var h=wysihtml.dom,m=function(a){this.el=a;this.isRowspan=this.isColspan=!1;this.isReal=this.lastRow=this.firstRow=this.lastCol=this.firstCol=!0;this.spanCollection=[];this.modified=!1},n=function(a,b){a?(this.cell=a,this.table=h.getParentElement(a,{query:"table"})):
b&&(this.table=b,this.cell=this.table.querySelectorAll("th, td")[0])};n.prototype={addSpannedCellToMap:function(a,b,d,f,g,h){for(var q=[],l=d+(h?parseInt(h,10)-1:0),p=f+(g?parseInt(g,10)-1:0),e=d;e<=l;e++){"undefined"==typeof b[e]&&(b[e]=[]);for(var k=f;k<=p;k++)b[e][k]=new m(a),b[e][k].isColspan=g&&1<parseInt(g,10),b[e][k].isRowspan=h&&1<parseInt(h,10),b[e][k].firstCol=k==f,b[e][k].lastCol=k==p,b[e][k].firstRow=e==d,b[e][k].lastRow=e==l,b[e][k].isReal=k==f&&e==d,b[e][k].spanCollection=q,q.push(b[e][k])}},
setCellAsModified:function(a){a.modified=!0;if(0<a.spanCollection.length)for(var b=0,d=a.spanCollection.length;b<d;b++)a.spanCollection[b].modified=!0},setTableMap:function(){var a=[],b=this.getTableRows(),d,f,g;for(d=0;d<b.length;d++){var e=b[d];e=this.getRowCells(e);var l=0;"undefined"==typeof a[d]&&(a[d]=[]);for(f=0;f<e.length;f++){for(g=e[f];"undefined"!=typeof a[d][l];)l++;var k=h.getAttribute(g,"colspan");var n=h.getAttribute(g,"rowspan");k||n?(this.addSpannedCellToMap(g,a,d,l,k,n),l+=k?parseInt(k,
10):1):(a[d][l]=new m(g),l++)}}return this.map=a},getRowCells:function(a){var b=this.table.querySelectorAll("table");b=b?e(b,"th, td"):[];a=a.querySelectorAll("th, td");return 0<b.length?wysihtml.lang.array(a).without(b):a},getTableRows:function(){var a=this.table.querySelectorAll("table");a=a?e(a,"tr"):[];var b=this.table.querySelectorAll("tr");return 0<a.length?wysihtml.lang.array(b).without(a):b},getMapIndex:function(a){for(var b=this.map.length,d=this.map&&this.map[0]?this.map[0].length:0,f=0;f<
b;f++)for(var g=0;g<d;g++)if(this.map[f][g].el===a)return{row:f,col:g};return!1},getElementAtIndex:function(a){this.setTableMap();return this.map[a.row]&&this.map[a.row][a.col]&&this.map[a.row][a.col].el?this.map[a.row][a.col].el:null},getMapElsTo:function(a){var b=[];this.setTableMap();this.idx_start=this.getMapIndex(this.cell);this.idx_end=this.getMapIndex(a);if(this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col)a=this.idx_start,this.idx_start=
this.idx_end,this.idx_end=a;this.idx_start.col>this.idx_end.col&&(a=this.idx_start.col,this.idx_start.col=this.idx_end.col,this.idx_end.col=a);if(null!=this.idx_start&&null!=this.idx_end){a=this.idx_start.row;for(var d=this.idx_end.row;a<=d;a++)for(var f=this.idx_start.col,g=this.idx_end.col;f<=g;f++)b.push(this.map[a][f].el)}return b},orderSelectionEnds:function(a){this.setTableMap();this.idx_start=this.getMapIndex(this.cell);this.idx_end=this.getMapIndex(a);if(this.idx_start.row>this.idx_end.row||
this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col)a=this.idx_start,this.idx_start=this.idx_end,this.idx_end=a;this.idx_start.col>this.idx_end.col&&(a=this.idx_start.col,this.idx_start.col=this.idx_end.col,this.idx_end.col=a);return{start:this.map[this.idx_start.row][this.idx_start.col].el,end:this.map[this.idx_end.row][this.idx_end.col].el}},createCells:function(a,b,d){for(var f=this.table.ownerDocument,g=f.createDocumentFragment(),h,e=0;e<b;e++){h=f.createElement(a);if(d)for(var l in d)d.hasOwnProperty(l)&&
h.setAttribute(l,d[l]);h.appendChild(document.createTextNode("\u00a0"));g.appendChild(h)}return g},correctColIndexForUnreals:function(a,b){b=this.map[b];for(var d=-1,f=0;f<a;f++)b[f].isReal&&d++;return d},getLastNewCellOnRow:function(a,b){a=this.getRowCells(a);for(var d,f,g=0,h=a.length;g<h;g++)if(d=a[g],f=this.getMapIndex(d),!1===f||"undefined"!=typeof b&&f.row!=b)return d;return null},removeEmptyTable:function(){var a=this.table.querySelectorAll("td, th");if(a&&0!=a.length)return!1;k(this.table);
return!0},splitRowToCells:function(a){if(a.isColspan){var b=parseInt(h.getAttribute(a.el,"colspan")||1,10),d=a.el.tagName.toLowerCase();1<b&&(b=this.createCells(d,b-1),l(a.el,b));a.el.removeAttribute("colspan")}},getRealRowEl:function(a,b){var d=null;b=b||this.idx;for(var f=0,g=this.map[b.row].length;f<g;f++){var l=this.map[b.row][f];if(l.isReal&&(d=h.getParentElement(l.el,{query:"tr"})))return d}null===d&&a&&(d=h.getParentElement(this.map[b.row][b.col].el,{query:"tr"})||null);return d},injectRowAt:function(a,
b,d,f,g){var e=this.getRealRowEl(!1,{row:a,col:b});d=this.createCells(f,d);e?(g=this.correctColIndexForUnreals(b,a),0<=g?l(this.getRowCells(e)[g],d):e.insertBefore(d,e.firstChild)):(e=this.table.ownerDocument.createElement("tr"),e.appendChild(d),l(h.getParentElement(g.el,{query:"tr"}),e))},canMerge:function(a){this.to=a;this.setTableMap();this.idx_start=this.getMapIndex(this.cell);this.idx_end=this.getMapIndex(this.to);if(this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&
this.idx_start.col>this.idx_end.col)a=this.idx_start,this.idx_start=this.idx_end,this.idx_end=a;this.idx_start.col>this.idx_end.col&&(a=this.idx_start.col,this.idx_start.col=this.idx_end.col,this.idx_end.col=a);a=this.idx_start.row;for(var b=this.idx_end.row;a<=b;a++)for(var d=this.idx_start.col,f=this.idx_end.col;d<=f;d++)if(this.map[a][d].isColspan||this.map[a][d].isRowspan)return!1;return!0},decreaseCellSpan:function(a,b){var d=parseInt(h.getAttribute(a.el,b),10)-1;1<=d?a.el.setAttribute(b,d):
(a.el.removeAttribute(b),"colspan"==b&&(a.isColspan=!1),"rowspan"==b&&(a.isRowspan=!1),a.firstCol=!0,a.lastCol=!0,a.firstRow=!0,a.lastRow=!0,a.isReal=!0)},removeSurplusLines:function(){var a,b;this.setTableMap();if(this.map){var d=0;for(a=this.map.length;d<a;d++){var f=this.map[d];var g=!0;var e=0;for(b=f.length;e<b;e++){var l=f[e];if(!(h.getAttribute(l.el,"rowspan")&&1<parseInt(h.getAttribute(l.el,"rowspan"),10)&&!0!==l.firstRow)){g=!1;break}}if(g)for(e=0;e<b;e++)this.decreaseCellSpan(f[e],"rowspan")}l=
this.getTableRows();d=0;for(a=l.length;d<a;d++)f=l[d],0==f.childNodes.length&&/^\s*$/.test(f.textContent||f.innerText)&&k(f)}},fillMissingCells:function(){var a=0,b;this.setTableMap();if(this.map){var d=this.map.length;for(b=0;b<d;b++)this.map[b].length>a&&(a=this.map[b].length);for(var f=0;f<d;f++)for(var g=0;g<a;g++)this.map[f]&&!this.map[f][g]&&0<g&&(this.map[f][g]=new m(this.createCells("td",1)),(b=this.map[f][g-1])&&b.el&&b.el.parent&&l(this.map[f][g-1].el,this.map[f][g].el))}},rectify:function(){if(this.removeEmptyTable())return!1;
this.removeSurplusLines();this.fillMissingCells();return!0},unmerge:function(){if(this.rectify()&&(this.setTableMap(),this.idx=this.getMapIndex(this.cell))){var a=this.map[this.idx.row][this.idx.col],b=h.getAttribute(a.el,"colspan")?parseInt(h.getAttribute(a.el,"colspan"),10):1,d=a.el.tagName.toLowerCase();if(a.isRowspan){var f=parseInt(h.getAttribute(a.el,"rowspan"),10);if(1<f){var g=1;for(--f;g<=f;g++)this.injectRowAt(this.idx.row+g,this.idx.col,b,d,a)}a.el.removeAttribute("rowspan")}this.splitRowToCells(a)}},
merge:function(a){if(this.rectify())if(this.canMerge(a)){a=this.idx_end.row-this.idx_start.row+1;for(var b=this.idx_end.col-this.idx_start.col+1,d=this.idx_start.row,f=this.idx_end.row;d<=f;d++)for(var g=this.idx_start.col,e=this.idx_end.col;g<=e;g++)d==this.idx_start.row&&g==this.idx_start.col?(1<a&&this.map[d][g].el.setAttribute("rowspan",a),1<b&&this.map[d][g].el.setAttribute("colspan",b)):(/^\s*<br\/?>\s*$/.test(this.map[d][g].el.innerHTML.toLowerCase())||(this.map[this.idx_start.row][this.idx_start.col].el.innerHTML+=
" "+this.map[d][g].el.innerHTML),k(this.map[d][g].el));this.rectify()}else window.console&&console.log("Do not know how to merge allready merged cells.")},collapseCellToNextRow:function(a){var b=this.getMapIndex(a.el),d=b.row+1,f={row:d,col:b.col};d<this.map.length&&(b=this.getRealRowEl(!1,f),null!==b&&(f=this.correctColIndexForUnreals(f.col,f.row),0<=f?l(this.getRowCells(b)[f],a.el):(d=this.getLastNewCellOnRow(b,d),null!==d?l(d,a.el):b.insertBefore(a.el,b.firstChild)),2<parseInt(h.getAttribute(a.el,
"rowspan"),10)?a.el.setAttribute("rowspan",parseInt(h.getAttribute(a.el,"rowspan"),10)-1):a.el.removeAttribute("rowspan")))},removeRowCell:function(a){a.isReal?a.isRowspan?this.collapseCellToNextRow(a):k(a.el):2<parseInt(h.getAttribute(a.el,"rowspan"),10)?a.el.setAttribute("rowspan",parseInt(h.getAttribute(a.el,"rowspan"),10)-1):a.el.removeAttribute("rowspan")},getRowElementsByCell:function(){var a=[];this.setTableMap();this.idx=this.getMapIndex(this.cell);if(!1!==this.idx)for(var b=this.map[this.idx.row],
d=0,f=b.length;d<f;d++)b[d].isReal&&a.push(b[d].el);return a},getColumnElementsByCell:function(){var a=[];this.setTableMap();this.idx=this.getMapIndex(this.cell);if(!1!==this.idx)for(var b=0,d=this.map.length;b<d;b++)this.map[b][this.idx.col]&&this.map[b][this.idx.col].isReal&&a.push(this.map[b][this.idx.col].el);return a},removeRow:function(){var a=h.getParentElement(this.cell,{query:"tr"});if(a){this.setTableMap();this.idx=this.getMapIndex(this.cell);if(!1!==this.idx)for(var b=this.map[this.idx.row],
d=0,f=b.length;d<f;d++)b[d].modified||(this.setCellAsModified(b[d]),this.removeRowCell(b[d]));k(a)}},removeColCell:function(a){a.isColspan?2<parseInt(h.getAttribute(a.el,"colspan"),10)?a.el.setAttribute("colspan",parseInt(h.getAttribute(a.el,"colspan"),10)-1):a.el.removeAttribute("colspan"):a.isReal&&k(a.el)},removeColumn:function(){this.setTableMap();this.idx=this.getMapIndex(this.cell);if(!1!==this.idx)for(var a=0,b=this.map.length;a<b;a++)this.map[a][this.idx.col].modified||(this.setCellAsModified(this.map[a][this.idx.col]),
this.removeColCell(this.map[a][this.idx.col]))},remove:function(a){if(this.rectify()){switch(a){case "row":this.removeRow();break;case "column":this.removeColumn()}this.rectify()}},addRow:function(a){var b=this.table.ownerDocument;this.setTableMap();this.idx=this.getMapIndex(this.cell);"below"==a&&h.getAttribute(this.cell,"rowspan")&&(this.idx.row=this.idx.row+parseInt(h.getAttribute(this.cell,"rowspan"),10)-1);if(!1!==this.idx){var d=this.map[this.idx.row];b=b.createElement("tr");for(var f=0,g=d.length;f<
g;f++)d[f].modified||(this.setCellAsModified(d[f]),this.addRowCell(d[f],b,a));switch(a){case "below":l(this.getRealRowEl(!0),b);break;case "above":(a=h.getParentElement(this.map[this.idx.row][this.idx.col].el,{query:"tr"}))&&a.parentNode.insertBefore(b,a)}}},addRowCell:function(a,b,d){var f=a.isColspan?{colspan:h.getAttribute(a.el,"colspan")}:null;a.isReal?"above"!=d&&a.isRowspan?a.el.setAttribute("rowspan",parseInt(h.getAttribute(a.el,"rowspan"),10)+1):b.appendChild(this.createCells("td",1,f)):"above"!=
d&&a.isRowspan&&a.lastRow?b.appendChild(this.createCells("td",1,f)):c.isRowspan&&a.el.attr("rowspan",parseInt(h.getAttribute(a.el,"rowspan"),10)+1)},add:function(a){this.rectify()&&("below"!=a&&"above"!=a||this.addRow(a),"before"!=a&&"after"!=a||this.addColumn(a))},addColCell:function(a,b,d){var f=a.el.tagName.toLowerCase();switch(d){case "before":var g=!a.isColspan||a.firstCol;break;case "after":g=!a.isColspan||a.lastCol||a.isColspan&&a.el==this.cell}if(g){switch(d){case "before":a.el.parentNode.insertBefore(this.createCells(f,
1),a.el);break;case "after":l(a.el,this.createCells(f,1))}a.isRowspan&&this.handleCellAddWithRowspan(a,b+1,d)}else a.el.setAttribute("colspan",parseInt(h.getAttribute(a.el,"colspan"),10)+1)},addColumn:function(a){this.setTableMap();this.idx=this.getMapIndex(this.cell);"after"==a&&h.getAttribute(this.cell,"colspan")&&(this.idx.col=this.idx.col+parseInt(h.getAttribute(this.cell,"colspan"),10)-1);if(!1!==this.idx)for(var b=0,d=this.map.length;b<d;b++){var f=this.map[b];f[this.idx.col]&&(f=f[this.idx.col],
f.modified||(this.setCellAsModified(f),this.addColCell(f,b,a)))}},handleCellAddWithRowspan:function(a,b,d){var f=parseInt(h.getAttribute(this.cell,"rowspan"),10)-1,g=h.getParentElement(a.el,{query:"tr"});a=a.el.tagName.toLowerCase();for(var e,k,n=this.table.ownerDocument,m=0;m<f;m++){e=this.correctColIndexForUnreals(this.idx.col,b+m);a:{for(g=g.nextSibling;1!=g.nodeType;)if(g=g.nextSibling,"tr"==g.tagName.toLowerCase())break a;g=null}if(g)if(0<e)switch(d){case "before":k=this.getRowCells(g);0<e&&
this.map[b+m][this.idx.col].el!=k[e]&&e==k.length-1?l(k[e],this.createCells(a,1)):k[e].parentNode.insertBefore(this.createCells(a,1),k[e]);break;case "after":l(this.getRowCells(g)[e],this.createCells(a,1))}else g.insertBefore(this.createCells(a,1),g.firstChild);else e=n.createElement("tr"),e.appendChild(this.createCells(a,1)),this.table.appendChild(e)}}};h.table={getCellsBetween:function(a,b){return(new n(a)).getMapElsTo(b)},addCells:function(a,b){(new n(a)).add(b)},removeCells:function(a,b){(new n(a)).remove(b)},
mergeCellsBetween:function(a,b){(new n(a)).merge(b)},unmergeCell:function(a){(new n(a)).unmerge()},orderSelectionEnds:function(a,b){return(new n(a)).orderSelectionEnds(b)},indexOf:function(a){var b=new n(a);b.setTableMap();return b.getMapIndex(a)},findCell:function(a,b){return(new n(null,a)).getElementAtIndex(b)},findRowByCell:function(a){return(new n(a)).getRowElementsByCell()},findColumnByCell:function(a){return(new n(a)).getColumnElementsByCell()},canMerge:function(a,b){return(new n(a)).canMerge(b)}}})();
(function(){var e=wysihtml.views.Composer.prototype.observe,k=function(){var e=function(){this.win.removeEventListener("load",e);this.doc.execCommand("enableObjectResizing",!1,"false");this.doc.execCommand("enableInlineTableEditing",!1,"false")}.bind(this),h=function(){e.call(this);this.actions.removeListeners(this.sandbox.getIframe(),["focus","mouseup","mouseover"],h)}.bind(this);this.doc.execCommand&&wysihtml.browser.supportsCommand(this.doc,"enableObjectResizing")&&wysihtml.browser.supportsCommand(this.doc,
"enableInlineTableEditing")&&(this.sandbox.getIframe?this.actions.addListeners(this.sandbox.getIframe(),["focus","mouseup","mouseover"],h):this.win.addEventListener("load",e));this.tableSelection=wysihtml.quirks.tableCellsSelection(this.element,this.parent)};wysihtml.Editor.prototype.defaults.handleTables=!0;wysihtml.quirks.tableCellsSelection=function(e,h){var k=function(){if(e){var a=e.querySelectorAll("."+p);if(0<a.length)for(var b=0;b<a.length;b++)f.removeClass(a[b],p)}},l=function(a){for(var b=
0;b<a.length;b++)f.addClass(a[b],p)},a=function(a){var b;(a=f.getParentElement(a.target,{query:"td, th"},!1,e))&&g.table&&g.start&&(b=f.getParentElement(a,{query:"table"},!1,e))&&b===g.table&&(k(),b=g.end,g.end=a,g.cells=f.table.getCellsBetween(g.start,a),1<g.cells.length&&h.composer.selection.deselect(),l(g.cells),g.end!==b&&h.fire("tableselectchange").fire("tableselectchange:composer"))},b=function(f){e.removeEventListener("mousemove",a);e.removeEventListener("mouseup",b);h.fire("tableselect").fire("tableselect:composer");
setTimeout(function(){e.ownerDocument.addEventListener("click",d)},0)},d=function(a){e.ownerDocument.removeEventListener("click",d);f.getParentElement(a.target,{query:"table"},!1,e)!=g.table&&(k(),g.table=null,g.start=null,g.end=null,h.fire("tableunselect").fire("tableunselect:composer"))},f=wysihtml.dom,g={table:null,start:null,end:null,cells:null,select:function(a,b){g.start=a;g.end=b;g.table=f.getParentElement(g.start,{query:"table"},!1,e);selectedCells=f.table.getCellsBetween(g.start,g.end);l(selectedCells);
e.ownerDocument.addEventListener("click",d);h.fire("tableselect").fire("tableselect:composer")}},p="wysiwyg-tmp-selected-cell";e.addEventListener("mousedown",function(d){if(d=wysihtml.dom.getParentElement(d.target,{query:"td, th"},!1,e))g.start=d,g.end=d,g.cells=[d],g.table=f.getParentElement(g.start,{query:"table"},!1,e),g.table&&(k(),f.addClass(d,p),e.addEventListener("mousemove",a),e.addEventListener("mouseup",b),h.fire("tableselectstart").fire("tableselectstart:composer"))});return g};wysihtml.views.Composer.prototype.observe=
function(){e.call(this);this.config.handleTables&&k.call(this)}})();
